use master
go

DROP DATABASE IF EXISTS QLBANHANG2
CREATE DATABASE QLBANHANG2
USE QLBANHANG2
GO

SET DATEFORMAT dmy
GO

DROP TABLE IF EXISTS CTHD
DROP TABLE IF EXISTS HOADON
DROP TABLE IF EXISTS KHACHHANG
DROP TABLE IF EXISTS VATTU
GO

CREATE TABLE KHACHHANG (
	MAKH VARCHAR(5) NOT NULL,
	TENKH NVARCHAR(30),
	DIACHIKH NVARCHAR(50),
	DT VARCHAR(11),
	EMAIL VARCHAR(30)
)
CREATE TABLE VATTU (
	MAVT VARCHAR(5) NOT NULL,
	TENVT NVARCHAR(30),
	DVT NVARCHAR(20),
	GIAMUA MONEY,
	SLTON INT
)
CREATE TABLE HOADON (
	MAHD VARCHAR(10) NOT NULL,
	NGAY DATE,
	MAKH VARCHAR(5),
	TONGTG FLOAT
)
CREATE TABLE CTHD (
	MAHD VARCHAR(10) NOT NULL,
	MAVT VARCHAR(5) NOT NULL,
	SL INT,
	KHUYENMAI FLOAT,
	GIABAN FLOAT
)
GO

ALTER TABLE KHACHHANG ADD
	CONSTRAINT PK_MAKH PRIMARY KEY (MAKH),
	--CONSTRAINT CK_DT CHECK (DATALENGTH(DT) >= 10)
	CONSTRAINT CK_DT CHECK (DT LIKE '[0-9][0-9][0-9][0-9][0-9][0-9][0-9][0-9][0-9][0-9]')
ALTER TABLE KHACHHANG
	ALTER COLUMN TENKH NVARCHAR(30) NOT NULL

ALTER TABLE VATTU ADD
	CONSTRAINT PK_MAVT PRIMARY KEY (MAVT),
	CONSTRAINT CK_GIAMUA CHECK (GIAMUA >0),
	CONSTRAINT CK_SLTON CHECK (SLTON >= 0)
ALTER TABLE VATTU
	ALTER COLUMN TENVT NVARCHAR(30) NOT NULL

ALTER TABLE HOADON ADD
	CONSTRAINT PK_MAHD PRIMARY KEY (MAHD),
	CONSTRAINT FK_MAKH FOREIGN KEY (MAKH) REFERENCES KHACHHANG(MAKH),
	CONSTRAINT CK_NGAY CHECK (NGAY <= GETDATE())

ALTER TABLE CTHD ADD
	CONSTRAINT PK_MAHD_MAVT PRIMARY KEY (MAHD, MAVT),
	CONSTRAINT FK_MAHD FOREIGN KEY (MAHD) REFERENCES HOADON(MAHD),
	CONSTRAINT FK_MAVT FOREIGN KEY (MAVT) REFERENCES VATTU(MAVT),
	CONSTRAINT CK_SL CHECK (SL > 0)
GO

INSERT INTO KHACHHANG
VALUES
	('KH01', N'Nguyễn Thị Bé', N'Tân Bình', '0938457895', 'bnt@yahoo.com'),
	('KH02', N'Lê Hoàng Nam', N'Bình Chánh', '0939878987', 'namlehoang@gmail.com'),
	('KH03', N'Trần Thị Chiêu', N'Tân Bình', '0938457895', NULL),
	('KH04', N'Mai Thị Quế Anh', N'Bình Chánh', NULL, NULL),
	('KH05', N'Lê Văn Sáng', N'Quận 10', NULL, 'sanglv@hcm.vnn.vn'),
	('KH06', N'Trần Hoàng', N'Tân Bình', '0938457897', NULL)
INSERT INTO VATTU
VALUES
	--('VT01', N'Xi măng', N'Bao', 50000, 5000),
	('VT02', N'Cát', N'Khối', 45000, 50000)
INSERT INTO VATTU VALUES	('VT03', N'Gạch ống', N'Viên', 120, 800000)
INSERT INTO VATTU VALUES	('VT04', N'Gạch thẻ', N'Viên', 110, 800000)
INSERT INTO VATTU VALUES	('VT05', N'Đá lớn', N'Khối', 25000, 100000)
INSERT INTO VATTU VALUES	('VT06', N'Đá nhỏ', N'Khối', 33000, 100000)
INSERT INTO VATTU VALUES	('VT07', N'Lam gió', N'Cái', 15000, 50000)

INSERT INTO HOADON
VALUES
	('HD001', '12/05/2010', 'KH01', NULL),
	('HD002', '25/05/2010', 'KH02', NULL),
	('HD003', '25/05/2010', 'KH01', NULL),
	('HD004', '25/05/2010', 'KH04', NULL),
	('HD005', '26/05/2010', 'KH04', NULL),
	('HD006', '02/06/2010', 'KH03' , NULL),
	('HD007', '22/06/2010', 'KH04', NULL),
	('HD008', '25/06/2010', 'KH03', NULL),
	('HD009', '15/08/2010', 'KH04', NULL),
	('HD010', '30/09/2010', 'KH01', NULL)
INSERT INTO CTHD
VALUES
	('HD001', 'VT01', 5, NULL, 52000),
	('HD001', 'VT05', 10, NULL, 30000),
	('HD002', 'VT03', 10000, NULL, 150),
	('HD003', 'VT02', 20, NULL, 55000),
	('HD004', 'VT03', 50000, NULL, 150),
	('HD004', 'VT04', 20000, NULL, 120),
	('HD005', 'VT05', 10, NULL, 30000),
	('HD005', 'VT06', 15, NULL, 35000),
	('HD005', 'VT07', 20, NULL, 17000),
	('HD006', 'VT04', 10000, NULL, 120),
	('HD007', 'VT04', 20000, NULL, 125),
	('HD008', 'VT01', 100, NULL, 55000),
	('HD008', 'VT02', 20, NULL, 47000),
	('HD009', 'VT02', 25, NULL, 48000),
	('HD010', 'VT01', 25, NULL, 57000)
GO

SELECT * FROM DBO.KHACHHANG
SELECT * FROM DBO.VATTU
SELECT * FROM DBO.HOADON
SELECT * FROM DBO.CTHD
GO